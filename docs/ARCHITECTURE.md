# VFD Display — Architecture Overview

Документ описывает архитектуру библиотеки, структуру слоёв, жизненный цикл данных
и взаимодействие между компонентами. Текст дополнен и уточнён в соответствии
с текущим состоянием кода (после разделения на LL/HL и переноса dot-blinking).

---

## 1. Общая структура проекта

Архитектура дисплея разделена на три уровня:

+------------------+
| API / PUBLIC | ← внешний уровень для приложений
+------------------+
| HIGH-LEVEL CORE | ← логика отображения, время, эффекты, оверлеи
+------------------+
| LOW-LEVEL (LL) | ← управление железом, PWM, refresh
+------------------+




**LL-слой** — минимальный и универсальный: работа с GPIO, сдвиговые регистры,
мультиплексирование, программный PWM и гамма-коррекция.

**HL-слой** — логика отображения:
- формирование буфера `hl_buffer[]`
- отрисовка времени/чисел/текста
- управление эффектами (FX)
- управление оверлеями (OVERLAY)
- яркость (ночной/авто режимы)
- heartbeat (`display_process()`)

**API-слой** — удобный интерфейс для приложений (часы, тесты, демки):
`display_show_time()`, `display_fx_pulse()`, `display_fx_morph()`, `display_process()` и т.д.

## 2. LOW-LEVEL LAYER (display_ll.c / display_ll.h)

### Задачи LL
LL отвечает за:
- формирование сырых масок сегментов для каждого разряда
- хранение яркости каждого разряда (0–255)
- гамма-коррекцию
- фоновое мультиплексирование разрядов
- программный PWM
- потокобезопасное обновление буферов

### Статус LL-слоя
Полностью завершён.

Реализовано:
- `display_ll_init()`
- `display_ll_start_refresh()`
- управление яркостью (per-digit и глобальная)
- гамма LUT и её применение
- стабильное мультиплексирование до 10 разрядов
- spinlock-защита
- полностью независим от HL/FX/OVERLAY

LL-слой НЕ содержит логики времени, эффектов и анимаций.

## 3. HIGH-LEVEL CORE (display_core.c)

HL-слой — центр управления дисплеем.

### Что содержит HL:
- `hl_buffer[]` — сформированный CONTENT
- текущий режим: `CONTENT`, `EFFECT`, `OVERLAY`
- dot-blink состояние и тайминги
- вызовы FX-движка (`display_fx_tick()`)
- передача данных в LL

### Что делает HL:
- принимает сегменты из content-слоя
- применяет dot-blink (обновлено и работает)
- при необходимости отдаёт управление FX и OVERLAY
- обновляет LL-буфер на каждом тике
- выполняет heartbeat (`display_process()`)

### Статус HL-core
Базовая логика готова  
Dot-blink перенесён  
Реальная работа с FX интегрирована  
Оверлеи подключены частично (минимальная инфраструктура без полного набора анимаций)

Прогресс: ~85%.

## 4. CONTENT LAYER (display_content.c / display_font.c)

### Основные задачи:
- преобразует числа, время, дату, текст → сегментные маски
- заполняет `hl_buffer[]`
- вызывает `display_core_set_buffer()`

### Реализовано:
`display_show_number()`  
`display_show_text()`  
`display_show_time()`  
`display_show_date()`  
шрифтовая таблица (`display_font.c`)  

### Планируется:
- прокрутка текста
- кастомные шрифты
- динамическая смена шрифта
- unicode-мэппер (опционально)

CONTENT полностью независим от низкого уровня.

## 5. FX LAYER (display_fx.c)

FX — переносимый эффектный движок дисплея.
Обновлено по фактическому состоянию кода.

### FX-движок реализует:
- FADE IN / FADE OUT
- PULSE («дыхание»)
- WAVE (волна яркости по разрядам)
- GLITCH (динамический фликер)
- MATRIX RAIN (яркостные «капли»)
- MORPH (плавный переход сегментных масок)
- DISSOLVE (рассыпающиеся сегменты)

### Особенности реализации:
- только один активный эффект одновременно
- state machine на структуре `fx_state_t`
- тайминги через `absolute_time_t` + `fx_elapsed_ms`
- эффекты изменяют:
  - либо яркость LL,
  - либо сегменты в HL-буфере.
- полная изоляция от LL (FX не трогает GPIO, таймеры, PWM)

### Статус FX-слоя
Полностью реализован.  
Все эффекты перенесены из легаси.  
Добавлены новые эффекты: `MORPH`, `DISSOLVE`.  
Интегрирован в HL.  

## 6. OVERLAY LAYER (display_overlay.c)

Оверлеи — временные режимы отображения поверх контента:
- boot-animation
- Wi-Fi / NTP
- «error» экран
- кастомные splash-экраны

Работают так:
1. HL сохраняет CONTENT
2. overlay показывает свои данные
3. overlay может использовать FX/яркость
4. после завершения HL восстанавливает CONTENT

### Статус overlay:
Реализованы основа и заглушки, но полный набор оверлеев ещё не перенесён.

## 7. HEARTBEAT / PROCESS LOOP

Функция:

```c
void display_process(void);
```

Запускается пользователем раз в цикл (while(1)).
Задачи:

* dot-blink (готово)
* update FX engine (готово)
* overlay FSM (частично)
* автояркость (в планах)
* ночной режим (в планах)
* плавное обновление времени (в планах)
* единый тик эффектов/анимаций

Архитектура не пользуется множеством таймеров, как в легаси; всё управляется через heartbeat.

## 8. Жизненный цикл данных

```
APP
│ display_show_time()
▼
CONTENT → формирует сегменты в hl_buffer[]
│
▼
HL CORE → dot-blink / effects / overlays
│
▼
LL → PWM / gamma / refresh / вывод сегментов
│
▼
HARDWARE (VFD)
```

## 9. Статус миграции (2025-11)
LL — завершён  
HL-core — 85%, FX полностью интегрирован  
CONTENT — полностью рабочий  
Dot-blinking — готов  
FX — полностью перенесён и работает  
Overlay — частично  
RTC-auto-update — в планах  
Auto/Night brightness — в планах

────────────────────────