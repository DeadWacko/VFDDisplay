
# VFD Display Library — Architecture Overview

**Версия:** `v1.0.0`
**Статус:** `stable`

Проект построен по строгой многослойной архитектуре, обеспечивающей изоляцию аппаратной части от бизнес-логики и системы эффектов.

```
+--------------------------+
|   APPLICATION (Main)     | ← Пользовательский код
+--------------------------+
|       API LAYER          | ← display_api.h (Фасад)
+--------------------------+
|    HIGH-LEVEL CORE       | ← State Machine, FX Engine, Logic
+--------------------------+
|    LOW-LEVEL DRIVER      | ← Hardware Abstraction, PWM, IRQ
+--------------------------+
```

---

## 1. Low-Level Layer (LL)
**Файлы:** `display_ll.c`, `display_ll.h`

Полностью автономный драйвер управления железом. Не имеет зависимостей от верхней логики.

**Ключевые механизмы:**
- **Развертка:** Использует `repeating_timer` для переключения сеток.
- **PWM:** Использует `hardware_alarm` для регулировки яркости (8 бит).
- **Anti-Ghosting:** Гарантированный dead-time (10 мкс) между переключениями.
- **Безопасность:** Все операции с буфером атомарны (`save_and_disable_interrupts`).
- **Гамма:** Аппаратная коррекция восприятия яркости ($x^2$).

LL **не знает** о времени, шрифтах, эффектах или оверлеях. Он просто выводит буфер сегментов с заданной яркостью.

---

## 2. High-Level Core (HL)
**Файлы:** `display_core.c`, `display_state.h`

Центральный хаб, хранящий глобальное состояние системы (`g_display`).

**Задачи:**
- Управление приоритетами отрисовки.
- Обработка мигания разделительных точек (1 Гц).
- Расчет автояркости (фильтрация ADC + гистерезис).
- Маршрутизация данных между Content, FX и LL.

**Стек приоритетов (Pipeline):**

```
1. OVERLAY       (Высший приоритет: Boot, WiFi, Errors)
      ↓
2. BLOCKING FX   (Захват сегментов: Glitch, Text, Morph)
      ↓
3. TRANSPARENT FX (Наложение яркости: Pulse, Wave, Scanner)
      ↓
4. CONTENT       (Базовый слой: Время, Числа)
```

---

## 3. FX Engine
**Файлы:** `display_fx.c`

Движок процедурных анимаций v4.0. Поддерживает "моментальные снимки" (Snapshot) состояния перед запуском эффекта.

### Классификация эффектов:

#### A. Прозрачные (Intensity Effects)
*Pulse, Wave, Scanner (KITT), Fade In/Out*
- Модифицируют только **яркость** в LL-слое.
- Позволяют `display_core` обновлять сегменты под эффектом.
- Пример: Часы идут (секунды меняются), пока по экрану бежит волна света.

#### B. Блокирующие (Structural Effects)
*Glitch, Morph, Dissolve, Ping-Pong*
- Временно захватывают управление **сегментами**.
- Блокируют обновление контента извне.
- По завершении восстанавливают исходное состояние экрана (Snapshot).

#### C. Текстовые (Text Effects)
*Marquee, Slide In*
- Используют выделенный буфер `fx_text_buffer[]`.
- Рендерят текст с прокруткой или анимацией появления.

---

## 4. Content Layer
**Файлы:** `display_content.c`, `display_font.c`

Слой представления данных.

**Функции:**
- **Font Mapping:** Преобразование ASCII в битовую маску конкретной разводки платы.
- **Rendering:** Форматирование чисел, времени (HH:MM), даты (DD.MM).
- **Text:** Поддержка алфавитно-цифрового вывода.

---

## 5. Цикл обновления (Heartbeat)

Функция `display_process()` должна вызываться в главном цикле. Логика одного тика:

1. **Auto-Brightness:** Чтение датчика света (если нет активных FX).
2. **Overlay Check:** Если активен Overlay → рендер и выход.
3. **FX Processing:**
   - Вызов `fx_tick()`.
   - Если эффект **Блокирующий** → обновление сегментов FX и выход.
   - Если эффект **Прозрачный** → обновление яркости FX и продолжение.
4. **Content Update:**
   - Расчет состояния мигающих точек.
   - Слияние контента и точек.
   - Отправка итогового кадра в Low-Level.

---

## 6. Итоги архитектуры v4.0

- **Thread-Safety:** LL-слой защищен от гонок данных.
- **Non-Blocking:** Прозрачные эффекты не останавливают ход часов.
- **State Recovery:** Гарантированное восстановление контента после анимаций.
- **Modularity:** Четкое разделение ответственности между файлами.
