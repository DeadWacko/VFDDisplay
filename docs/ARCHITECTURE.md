# VFD Display — Architecture Overview

Документ описывает архитектуру библиотеки, структуру слоёв, жизненный цикл данных
и взаимодействие между компонентами. Текст дополнен и уточнён в соответствии
с текущим состоянием кода (после разделения на LL/HL и переноса dot-blinking).

---

## 1. Общая структура проекта

Архитектура дисплея разделена на три уровня:

+------------------+
| API / PUBLIC | ← внешний уровень для приложений
+------------------+
| HIGH-LEVEL CORE | ← логика отображения, время, эффекты, оверлеи
+------------------+
| LOW-LEVEL (LL) | ← управление железом, PWM, refresh
+------------------+



**LL-слой** — минимальный и универсальный: работа с GPIO, сдвиговые регистры,
мультиплексирование, программный PWM и гамма-коррекция.

**HL-слой** — логика отображения:
- формирование буфера `hl_buffer[]`
- отрисовка времени/чисел/текста
- эффекты (FX)
- оверлеи (Wi-Fi, boot, NTP)
- яркость (ночной/авто режимы)
- heartbeat / общий цикл обновления (`display_process()`)

**API-слой** — модуль, предоставляющий удобные функции приложению:
`display_show_time`, `display_set_dot_blinking`, `display_init`, `display_process` и т.д.

---

## 2. LOW-LEVEL LAYER (display_ll.c / display_ll.h)

### Основные задачи
LL отвечает за:
- формирование сырых масок сегментов для каждого разряда
- хранение яркости каждого разряда (0–255)
- фоновое мультиплексирование разрядов
- программный PWM
- гамма-коррекцию
- таймеры (основной fast-timer + будильник для гашения сегментов)

### Статус LL-слоя
✔ **Полностью завершён.**

Реализовано:
- `display_ll_init()`
- `display_ll_start_refresh()`
- `display_ll_set_brightness[all]()`
- `display_ll_set_digit_raw()`
- `display_ll_apply_gamma()`
- spinlock-защита буферов
- стабильное мультиплексирование (до 10 разрядов)
- совместимость с любым количеством сегментов (8-битная маска)

LL-слой полностью отделён от остального кода и не содержит понятий
время/эффект/анимация.

---

## 3. HIGH-LEVEL CORE (display_core.c)

HL-слой — центр управления дисплеем. Он оперирует с:

### Что хранит HL:
- `hl_buffer[]` — сформированный контент
- текущую яркость
- режим (`CONTENT`, `EFFECT`, `OVERLAY`)
- dot-blink состояние
- служебные тайминги

### Что делает HL:
- принимает от content-слоя сегментные маски
- применяет dot-blinking (уже реализовано)
- готовит буфер для отправки в LL
- передаёт данные через `display_ll_set_digit_raw`
- будет управлять эффектами и оверлеями (через FSM)
- выполняет heartbeat (`display_process()`)

### Новое (реализовано):
✔ `display_set_dot_blinking()`  
✔ логика мигания DP в `display_process()`  
✔ синхронизация dot-blink раз в ~1000 мс  
✔ передача обновлённого HL-буфера в LL  

### Статус HL-core
Прогресс: **~70–80%**  
(всё базовое работает, эффектов/оверлеев/RTC пока нет)

---

## 4. CONTENT LAYER (display_content.c / display_font.c)

Задачи content-слоя:
- преобразовать числа, текст, время, дату в сегментную маску
- заполнять `hl_buffer[]`
- вызывать `display_core_set_buffer()`

Реализовано:
✔ `display_show_number()`  
✔ `display_show_text()`  
✔ `display_show_time()`  
✔ `display_show_date()`  
✔ доступ к сегментной таблице (`display_font.c`)  

Не реализовано пока:
- прокрутка текстов  
- морфинг цифр  
- кастомные шрифты  

---

## 5. FX LAYER (будущий display_fx.c)

Этот слой будет отвечать за:
- анимации (fade, wave, pulse, flicker)
- временные состояния эффектов
- корректное завершение эффекта
- управление яркостью/буфером в рамках анимации
- взаимодействие с HL через FSM

Каждый эффект будет:
1) перехватывать управление HL-слоем  
2) обновляться на каждом heartbeat  
3) изменять HL-буфер или яркость  
4) освобождать управление по завершении  

FX будет использовать общий тик `display_process()`.

Статус FX: **ещё не перенесено из легаси**.

---

## 6. OVERLAY LAYER (будущий display_overlay.c)

Оверлеи — временные состояния поверх контента:
- загрузка (`boot`)
- подключение к Wi-Fi
- синхронизация времени (NTP)
- ошибки

Принцип работы:
1) HL сохраняет `hl_buffer[]`
2) overlay перехватывает экран
3) показывает свою анимацию или текст
4) по завершении возвращает `CONTENT` и восстанавливает буфер

Статус overlay: **не перенесено**.

---

## 7. HEARTBEAT / PROCESS LOOP

Единая функция:
void display_process(void);



Задачи heartbeat:
- мигание точки (реализовано)
- эффекты (будет после переноса)
- оверлеи
- автояркость
- ночной режим
- плавное обновление времени
- синхронизация анимаций

Функция вызывается пользователем из главного цикла (`while(1)`).

Такой подход позволяет избегать хаоса в виде множества таймеров (как в легаси).

---

## 8. Жизненный цикл данных

[APP]
│
│ display_show_time(...) / display_show_number()
▼
[CONTENT] → формирует сегменты в hl_buffer[]
│
▼
[HL CORE] → dot-blink / effects / overlays
│
▼
[LL] → PWM / refresh / вывод сегментов
│
▼
HARDWARE (VFD)



---

## 9. Статус миграции (на 2025-xx)

✔ LL — полностью завершён  
✔ HL-core — базовые функции реализованы  
✔ CONTENT — операции с числами/временем/датой готовы  
✔ Dot-blinking — перенесён  
❌ FX — впереди  
❌ Overlay — впереди  
❌ RTC-auto-update — впереди  
❌ Auto/Night brightness — впереди  