# VFD Display — Effects System (FX)

Этот документ описывает архитектуру эффектов (анимаций), которые будут перенесены из легаси (`display.c`) в новый модуль `display_fx.c`.  
Документ дополнен и приведён в соответствие с новой LL/HL структурой.

## 1. Цели FX-слоя

Эффекты должны быть:
- полностью изолированы от LL-слоя
- управляемы через HL-режимы (`MODE_EFFECT`)
- обновляться на каждом тике `display_process()`
- иметь простой интерфейс запуска/остановки
- работать независимо от CONTENT и OVERLAY

**FX-слой не меняет железо напрямую** — он управляет только **HL-буфером** или **яркостью**.

---

## 2. Общая архитектура FX

FX-слой работает как state machine:


APP → display_fx_xxx() → FX_STATE_ACTIVE
display_process() → обновляет эффект
по завершении → FX_STATE_IDLE → CONTENT восстановлен


**Когда запускается эффект:**
1. CONTENT-буфер CONTENT сохраняется
2. Активируется `MODE_EFFECT`
3. FX получает контроль над выводом (буфер или яркость)
4. На каждом тике `display_process()` эффект обновляет:
   - яркость
   - сегменты
   - временные маски
5. Когда эффект заканчивается — управление возвращается CONTENT

---

## 3. Структура FX-слоя

Будущий файл `display_fx.c` будет содержать:

### 3.1. Глобальное состояние

```c
typedef struct {
    bool active;
    display_effect_t current;
    uint32_t start_ms;
    uint32_t duration_ms;
    
    // Параметры эффекта
    uint8_t wave_phase;
    uint8_t flicker_seed;
    uint8_t fade_level;
    
    // Сохранённый CONTENT-буфер
    vfd_seg_t saved_buffer[VFD_MAX_DIGITS];
} display_fx_state_t;
```

### 3.2. Перечень эффектов

```c
typedef enum {
    FX_NONE = 0,
    FX_FADE_IN,
    FX_FADE_OUT,
    FX_WAVE,
    FX_PULSE,
    FX_GLITCH,
    FX_MATRIX,
    FX_DISSOLVE,
    FX_MORPH
} display_effect_t;
```

---

## 4. Переносимые эффекты (описания)

Ниже — эффекты, которые были в легаси (или нужны по спецификации), и которые будут реализованы поверх HL-буфера.

### 4.1. FADE IN / FADE OUT
- Тип: яркостная анимация
- Управляет: `display_ll_set_brightness_all()` или per-digit
- Принцип работы: яркость меняется от `0 → 255` (fade-in) или `255 → 0` (fade-out)
- Плавность обеспечивается LL-гаммой
- CONTENT-буфер не трогается

### 4.2. PULSE (дыхание)
- Тип: синусоидальная яркость
- Управляет: LL-яркостью
- Реализация:
  ```c
  brightness = sin(phase) * 255;
  phase += speed;
  ```
- HL-буфер остаётся неизменным

### 4.3. WAVE (волна яркости по разрядам)
- Тип: динамическая яркость разрядов
- Управляет: `display_ll_set_brightness(index)`
- Пример:
  ```c
  digit[i].brightness = sin(phase + i * shift);
  ```

### 4.4. FLICKER / GLITCH (хаотичное мерцание)
- Тип: псевдорандомные отключения сегментов
- Управляет: HL-буфером
- Принцип работы:
  - берётся сохранённый CONTENT-буфер
  - случайно выключаются сегменты на нескольких тиках
  - затем постепенно восстанавливаются

### 4.5. MATRIX RAIN (случайные "капли" яркости)
- Тип: яркостная анимация
- Управляет: индивидуальной яркостью разрядов
- Имитирует «цифровой дождь» из Матрицы

### 4.6. DISSOLVE (рассыпание сегментов)
- Тип: сегментная анимация
- Управляет: HL-буфером
- Алгоритм:
  - каждый сегмент получает случайную задержку выключения
  - по таймеру сегменты «осыпаются» (turn off)

### 4.7. MORPH TO (цифра → цифра)
- Тип: переход
- Управляет: HL-буфером
- Использует несколько промежуточных масок сегментов

---

## 5. Интерфейсы FX (текущие функции)

```c
bool display_fx_fade_in(uint32_t duration_ms);
bool display_fx_fade_out(uint32_t duration_ms);
bool display_fx_pulse(uint32_t duration_ms);
bool display_fx_wave(uint32_t duration_ms);
bool display_fx_glitch(uint32_t duration_ms);
bool display_fx_matrix_rain(uint32_t duration_ms);
void display_fx_stop(void);
bool display_is_effect_running(void);
```

Все эффекты управляются через общий heartbeat `display_process()` → `display_fx_tick()`.

---

## 6. Статус миграции

Реальное состояние на текущий момент (см. `display_fx.c`):



| Эффект            | Статус                                          |
|--------------------|--------------------------------------------------|
| Fade In            | перенесён (`FX_TYPE_FADE_IN`)                 |
| Fade Out           | перенесён (`FX_TYPE_FADE_OUT`)                |
| Pulse              | перенесён (`FX_TYPE_PULSE`)                   |
| Wave               | перенесён (`FX_TYPE_WAVE`)                    |
| Flicker/Glitch     | перенесён (`FX_TYPE_GLITCH`)                  |
| Matrix Rain        | реализован (`FX_TYPE_MATRIX`)                 |
| Dissolve           | не перенесён (будущий сегментный эффект)     |
| Morph              | не перенесён (плавный переход цифра→цифра)    |

FX-слой уже работает как state machine поверх LL-яркости:
- один эффект за раз;
- все тайминги считаются от `start_time` через `display_fx_tick()`;
- при завершении эффект восстанавливает базовую яркость или исходные сегменты.

---

## 7. Принципы разработки FX

- Эффект **никогда** не лезет в LL напрямую
- CONTENT-буфер **всегда** сохраняется и восстанавливается
- Эффект **обязан** заканчиваться сам
- Эффект **не должен** заново инициализировать LL
- Один эффект за раз: режим `MODE_EFFECT`
---
Документ будет дополняться по мере переноса логики из легаси в новый FX-модуль.

----
Обновлено: 27.11.2025 — основные яркостные эффекты перенесены, добавлен Matrix Rain.
