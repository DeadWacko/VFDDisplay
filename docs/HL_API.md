# High-Level Layer (HL) — API Reference

**Версия:** `v1.3.0`
**Статус:** `stable`

---

## 1. Обзор

HL (High-Level) слой предоставляет абстракцию для создания пользовательских приложений (Часы, Таймеры, Информационные табло). Он управляет логикой отображения, анимациями и приоритетами вывода.

**Ключевые возможности:**
*   **Умный рендеринг:** Автоматическое преобразование чисел, времени и строк в сегментный код.
*   **Flexible Config:** Поддержка произвольной распиновки GPIO.
*   **FX Engine:** Встроенный движок эффектов (13 режимов) с поддержкой прозрачности.
*   **State Machine:** Автоматическое управление приоритетами (Оверлей > Эффект > Контент).
*   **System Control:** Автояркость, ночной режим, гибкое управление разделителями.

---

## 2. Инициализация и Цикл

### `void display_init(uint8_t digit_count)`
Стандартная инициализация. Использует пины по умолчанию:
*   **Data:** GP15
*   **Clock:** GP14
*   **Latch:** GP13
*   **Refresh Rate:** 120 Hz

### `void display_init_ex(const display_ll_config_t *cfg)`
**New in v1.3.0.** Расширенная инициализация с пользовательской конфигурацией.
Позволяет задать кастомные GPIO и частоту обновления.

**Пример:**
```c
display_ll_config_t cfg = {
    .data_pin = 2, .clock_pin = 3, .latch_pin = 4,
    .digit_count = 6, .refresh_rate_hz = 100
};
display_init_ex(&cfg);
```

### `void display_process(void)`
Главная функция обработки (Heartbeat). **Обязательна** к вызову в главном цикле `while(1)`.
Отвечает за:
*   Обновление кадров анимации (FX).
*   Расчет автояркости (чтение ADC).
*   Мигание разделительных точек (по маске).
*   Возврат к отображению времени после окончания эффектов.

---

## 3. Вывод Контента

Эти функции обновляют буфер экрана.
*   Если активен "прозрачный" эффект (например, Pulse), данные обновятся "под" эффектом.
*   Если активен "блокирующий" эффект (например, Glitch), данные обновятся в памяти, но появятся на экране только после окончания эффекта.

### `void display_show_time(uint8_t hh, uint8_t mm, bool show_colon)`
Выводит время в формате `HHMM` (или `HMM` для малых дисплеев).
*   **hh/mm:** Часы и минуты.
*   **show_colon:** *Deprecated (v1.2.0).* Аргумент игнорируется. Для включения разделителя используйте `display_set_dots_config()`.

### `void display_show_date(uint8_t day, uint8_t month)`
Выводит дату в формате `DDMM`. Точки больше не устанавливаются принудительно.

### `void display_show_number(int32_t value)`
Выводит целое число с выравниванием по правому краю.
*   Поддерживает отрицательные числа (рисует знак `-`).
*   Безопасно обрабатывает `INT32_MIN`.

### `void display_show_text(const char *text)`
Выводит строку.
*   **Поддерживаемые символы:** `0-9`, `A-Z` (латиница), пробел, `-`, `_`.
*   **Десятичная точка:** Если в строке есть точка (например `"12.3"`), она привязывается к предыдущему символу.

---

## 4. Система Эффектов (FX API)

Движок поддерживает три типа эффектов. Все функции возвращают `true` при успешном запуске.

### 4.1 Прозрачные эффекты (Transparent)
*Меняют яркость. Контент продолжает обновляться.*
*Примечание:* С версии v1.1.1 автояркость работает **совместно** с этими эффектами, масштабируя их амплитуду.

| Функция | Описание |
|---|---|
| `display_fx_pulse(ms)` | Плавное синусоидальное "дыхание" яркости. |
| `display_fx_wave(ms)` | Волна яркости, бегущая слева направо. |
| `display_fx_scanner(ms)` | (Matrix) Эффект "KITT" — бегающее яркое пятно. |
| `display_fx_fade_in(ms)` | Плавное включение из темноты. |
| `display_fx_fade_out(ms)` | Плавное затухание в темноту. |

### 4.2 Блокирующие эффекты (Blocking)
*Захватывают сегменты. Контент не обновляется до завершения.*

| Функция | Описание |
|---|---|
| `display_fx_glitch(ms)` | Цифровой шум, хаотичное подергивание сегментов. |
| `display_fx_dissolve(ms)` | Рассыпание изображения на случайные сегменты ("песок"). |
| `display_fx_morph(ms, target, steps)` | Плавное превращение текущего экрана в буфер `target`.<br>**target:** массив типа `vfd_segment_map_t`. |

### 4.3 Текстовые анимации
*Используются для показа сообщений, длиннее чем экран.*

| Функция | Описание |
|---|---|
| `display_fx_marquee(text, speed)` | Бегущая строка (справа налево). `speed` — мс на 1 сдвиг. |
| `display_fx_slide_in(text, speed)` | Текст выезжает справа и останавливается. |

### Управление FX
```c
void display_fx_stop(void);        // Принудительно остановить эффект
bool display_is_effect_running(void); // Проверить, активна ли анимация
```

---

## 5. Настройки системы

### Разделители (Dots/Separators) — New in v1.2.0

Теперь разделительные точки управляются отдельно от контента.

```c
// Настройка маски и режима точек
// mask: Битовая маска. Бит 1 = точка включена на этом разряде.
//       Пример: (1 << 1) — точка на 2-м разряде (индекс 1).
// blink: true = точки мигают (1 Гц), false = горят постоянно.
void display_set_dots_config(uint16_t mask, bool blink);

// Быстрое переключение режима (мигание/статика) для текущей маски
void display_set_dot_blinking(bool enable);
```

### Яркость
```c
// Установить фиксированную яркость (0..255)
void display_set_brightness(uint8_t value);

// Включить авто-яркость по датчику (ADC)
// Блокирует ручную установку яркости.
void display_set_auto_brightness(bool enable);

// Включить "Ночной режим"
void display_set_night_mode(bool enable);
```

### Диагностика
```c
// Получить текущий режим работы
// DISPLAY_MODE_CONTENT, DISPLAY_MODE_EFFECT, DISPLAY_MODE_OVERLAY
display_mode_t display_get_mode(void);
```

---

## 6. Пример использования (Типовой сценарий)

```c
#include "display_api.h"

int main() {
    // 1. Инициализация (v1.3.0 Custom Config)
    display_ll_config_t cfg = {
        .data_pin = 2, .clock_pin = 3, .latch_pin = 4,
        .digit_count = 4, .refresh_rate_hz = 120
    };
    display_init_ex(&cfg);
    
    // 2. Настройка разделителя (для часов HH.MM точка на индексе 1)
    // Маска: 0010 (binary) -> 0x02. Режим: мигание.
    display_set_dots_config((1 << 1), true);
    
    // 3. Приветствие
    display_fx_slide_in("HI", 150);
    while(display_is_effect_running()) { display_process(); sleep_ms(10); }

    while(true) {
        display_process(); // Heartbeat
        
        // Обновление времени (show_colon = false/ignored)
        update_time(); 
        display_show_time(hour, min, false);
        
        // Эффект каждый час
        if (new_hour_event) {
            display_fx_wave(2000);
        }
        
        sleep_ms(10);
    }
}
```