
---

# High-Level Layer (HL) — API Reference

**Версия:** `v1.0.0`
**Статус:** `stable`

---

## 1. Обзор

HL (High-Level) слой предоставляет абстракцию для создания пользовательских приложений (Часы, Таймеры, Информационные табло). Он управляет логикой отображения, анимациями и приоритетами вывода.

**Ключевые возможности:**
*   **Умный рендеринг:** Автоматическое преобразование чисел, времени и строк в сегментный код.
*   **FX Engine:** Встроенный движок эффектов (13 режимов) с поддержкой прозрачности.
*   **State Machine:** Автоматическое управление приоритетами (Оверлей > Эффект > Контент).
*   **System Control:** Автояркость, ночной режим, мигание разделительных точек.

---

## 2. Инициализация и Цикл

### `void display_init(uint8_t digit_count)`
Инициализирует всю подсистему дисплея (включая LL-драйвер).
*   **digit_count:** Количество разрядов (например, 4 или 6).
*   *Примечание:* Сразу включает дисплей на максимальной яркости.

### `void display_process(void)`
Главная функция обработки (Heartbeat). **Обязательна** к вызову в главном цикле `while(1)`.
Отвечает за:
*   Обновление кадров анимации (FX).
*   Расчет автояркости (чтение ADC).
*   Мигание разделительных точек (1 Гц).
*   Возврат к отображению времени после окончания эффектов.

**Пример:**
```c
while (true) {
    display_process(); // Крутит анимации и логику
    // ... ваш код ...
    sleep_ms(5);
}
```

---

## 3. Вывод Контента

Эти функции обновляют буфер экрана. Если активен "прозрачный" эффект (например, Pulse), данные обновятся "под" эффектом. Если активен "блокирующий" эффект (например, Glitch), данные обновятся в памяти, но появятся на экране только после окончания эффекта.

### `void display_show_time(uint8_t hh, uint8_t mm, bool show_colon)`
Выводит время в формате `HHMM`.
*   **hh/mm:** Часы и минуты.
*   **show_colon:** Если `true`, принудительно включает точку/двоеточие (зависит от разводки).

### `void display_show_date(uint8_t day, uint8_t month)`
Выводит дату в формате `DD.MM`.

### `void display_show_number(int32_t value)`
Выводит целое число с выравниванием по правому краю.
*   Поддерживает отрицательные числа (рисует знак `-`).

### `void display_show_text(const char *text)`
Выводит строку.
*   **Поддерживаемые символы:** `0-9`, `A-Z` (латиница), пробел, `-`, `_`.
*   **Десятичная точка:** Если в строке есть точка (например `"12.3"`), она привязывается к предыдущему символу (включает сегмент DP).

---

## 4. Система Эффектов (FX API)

Движок поддерживает три типа эффектов. Все функции возвращают `true` при успешном запуске.

### 4.1 Прозрачные эффекты (Transparent)
*Меняют яркость. Контент (время) продолжает обновляться.*

| Функция | Описание |
|---|---|
| `display_fx_pulse(ms)` | Плавное синусоидальное "дыхание" яркости. |
| `display_fx_wave(ms)` | Волна яркости, бегущая слева направо. |
| `display_fx_scanner(ms)` | (Matrix) Эффект "KITT" — бегающее яркое пятно. |
| `display_fx_fade_in(ms)` | Плавное включение из темноты. |
| `display_fx_fade_out(ms)` | Плавное затухание в темноту. |

### 4.2 Блокирующие эффекты (Blocking)
*Захватывают сегменты. Контент не обновляется до завершения.*

| Функция | Описание |
|---|---|
| `display_fx_glitch(ms)` | Цифровой шум, хаотичное подергивание сегментов. |
| `display_fx_dissolve(ms)` | Рассыпание изображения на случайные сегменты ("песок"). |
| `display_fx_morph(ms, target, steps)` | Плавное побитовое превращение текущего экрана в `target`. |



### 4.3 Текстовые анимации
*Используются для показа сообщений, длиннее чем экран.*

| Функция | Описание |
|---|---|
| `display_fx_marquee(text, speed)` | Бегущая строка (справа налево). `speed` — мс на 1 сдвиг. |
| `display_fx_slide_in(text, speed)` | Текст выезжает справа и останавливается. |

### Управление FX
```c
void display_fx_stop(void);        // Принудительно остановить эффект
bool display_is_effect_running(void); // Проверить, активна ли анимация
```

---

## 5. Настройки системы

### Яркость
```c
// Установить фиксированную яркость (0..255)
void display_set_brightness(uint8_t value);

// Включить авто-яркость по датчику (ADC)
// Блокирует ручную установку яркости.
void display_set_auto_brightness(bool enable);

// Включить "Ночной режим"
// Снижает яркость в заданный интервал времени (требует RTC).
void display_set_night_mode(bool enable);
```

### Индикация
```c
// Включить мигание точек (1 Гц)
// Работает независимо от обновления контента.
void display_set_dot_blinking(bool enable);
```

### Диагностика
```c
// Получить текущий режим работы
// DISPLAY_MODE_CONTENT, DISPLAY_MODE_EFFECT, DISPLAY_MODE_OVERLAY
display_mode_t display_get_mode(void);
```

---

## 6. Пример использования (Типовой сценарий)

```c
#include "display_api.h"

int main() {
    display_init(4);
    
    // Приветствие
    display_fx_slide_in("HI", 150);
    while(display_is_effect_running()) { display_process(); sleep_ms(10); }

    // Основной режим
    display_set_dot_blinking(true);
    
    while(true) {
        // Обязательный тик движка
        display_process();
        
        // Обновление времени (ваша функция)
        update_time(); 
        display_show_time(hour, min, true);
        
        // Запуск эффекта по событию (например, ровно в 00 секунд)
        if (sec == 0 && !display_is_effect_running()) {
            display_fx_wave(2000);
        }
        
        sleep_ms(10);
    }
}
```