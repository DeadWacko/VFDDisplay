# VFD Display — Effects System (FX)

**Версия:** 1.3.7
**Статус:** Stable

Документ описывает архитектуру движка эффектов `display_fx.c` и классификацию визуальных режимов.

---

## 1. Концепция

Движок эффектов работает поверх основного контента, обеспечивая:
1.  **Прозрачность:** Эффекты яркости накладываются на идущие часы.
2.  **Безопасность:** Блокирующие эффекты (Glitch) сохраняют состояние экрана перед запуском и восстанавливают его после.
3.  **Совместимость:** Автояркость масштабирует амплитуду эффектов под условия освещения.

---

## 2. Классификация Эффектов

### Группа A: Прозрачные (Intensity Effects)
Модифицируют **только яркость** в LL-слое. Контент продолжает обновляться.

| Эффект | Описание | Визуализация |
|---|---|---|
| **Pulse** | Синусоидальное "дыхание". | Плавное затухание до 5% и возврат к 100%. |
| **Wave** | Волна яркости. | Световое пятно пробегает слева направо. |
| **Scanner** | Эффект "Matrix" / "KITT". | Яркий "глаз" бегает туда-сюда с затухающим шлейфом. Скорость настраивается через `frame_ms`. |
| **Fade In/Out** | Глобальное затухание. | Плавный уход в черноту и обратно. |


### Группа B: Блокирующие (Structural Effects)
Захватывают управление **сегментами**. Обновление контента приостанавливается.

| Эффект | Описание | Примечание |
|---|---|---|
| **Morph** | Побитовое превращение. | Плавная трансформация текущего экрана в целевой буфер. **Фиксирует** новое состояние по завершении. |
| **Dissolve** | Рассыпание. | Пиксели гаснут в случайном порядке. |
| **Glitch** | Цифровой сбой. | Хаотичная подмена сегментов. |

### Группа C: Текстовые
Используют внутренний буфер для рендеринга строк.

| Эффект | Описание | Опции |
|---|---|---|
| **Marquee** | Бегущая строка. | Длительность рассчитывается автоматически по длине текста. |
| **Slide In** | Выезд текста. | Текст выезжает справа и фиксируется. |

---

## 3. Внутренняя логика

### Snapshot & Restore
1.  При старте эффекта текущий буфер дисплея сохраняется в `saved_content_buffer`.
2.  При штатном завершении или прерывании (например, Оверлеем) вызывается `fx_finish_internal()`, который восстанавливает сохраненный буфер.
3.  Исключение: **Morph** при завершении записывает свой результат как новое "чистое" состояние.

### Взаимодействие с Оверлеями
Если во время работы эффекта запускается Оверлей (Boot/WiFi):
1.  Активный эффект принудительно и корректно завершается (`display_fx_stop`).
2.  Восстанавливается чистый контент.
3.  Оверлей делает свой снимок экрана и начинает работу.


TODO: Переименовать название эффектов Boot, WIFI, NTP. Название не придумал.